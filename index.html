<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Journal</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f5f5f7;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        h1 {
            text-align: center;
            font-size: 32px;
            margin: 20px 0 15px;
            font-weight: 600;
        }
        #header-controls {
            text-align: center;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        #top-buttons {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        #addEntry {
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 14px;
            padding: 16px 32px;
            font-size: 19px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }
        #calendarBtn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            padding: 8px;
        }
        #toggleView {
            background-color: #000000;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 28px;
            font-size: 16px;
            cursor: pointer;
        }
        #searchBar {
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
            padding: 14px 18px;
            font-size: 17px;
            border-radius: 14px;
            border: 1px solid #ddd;
            background-color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        #searchBar::placeholder {
            color: #aaa;
        }

        /* Calendar Modal */
        #calendarModal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        #calendarContainer {
            background: white;
            border-radius: 16px;
            padding: 20px;
            width: 320px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        #calendarHeader {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 20px;
            font-weight: bold;
        }
        #calendarGrid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            text-align: center;
        }
        .day-name {
            font-weight: bold;
            color: #666;
            font-size: 14px;
        }
        .day {
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
        }
        .day.has-entry {
            background-color: #007aff;
            color: white;
            font-weight: bold;
        }
        .day.today {
            border: 2px solid #007aff;
            box-sizing: border-box;
        }
        .day.other-month {
            color: #ccc;
        }

        #entries {
            max-width: 800px;
            margin: 0 auto;
        }
        .month-header {
            position: sticky;
            top: 0;
            background-color: #f0f0f0;
            padding: 12px 20px;
            font-size: 20px;
            font-weight: bold;
            color: #333;
            border-bottom: 1px solid #ddd;
            margin: 30px 0 10px 0;
            border-radius: 12px 12px 0 0;
            z-index: 10;
        }
        .entry {
            background-color: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: flex-start;
            gap: 14px;
        }
        .compact .entry {
            padding: 14px;
            align-items: center;
        }
        .entry-thumb {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            object-fit: cover;
            flex-shrink: 0;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .compact .entry-thumb {
            width: 50px;
            height: 50px;
        }
        .entry-content {
            flex: 1;
        }
        .entry-date {
            font-size: 17px;
            color: #007aff;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .entry-title {
            font-size: 24px;
            font-weight: bold;
            margin: 8px 0;
            padding: 8px 0;
            border: none;
            background: transparent;
            width: 100%;
        }
        .entry-title:focus {
            outline: none;
            border-bottom: 2px solid #007aff;
        }
        .compact .entry-title {
            font-size: 18px;
            margin: 0;
        }
        .entry-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 16px;
        }
        .entry-gallery img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .entry-gallery img:hover { transform: scale(1.05); }
        .compact .entry-gallery { display: none; }

        /* Lightbox and Form (same as before) */
        #lightbox { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); justify-content: center; align-items: center; z-index: 1000; }
        #lightbox img { max-width: 95%; max-height: 95%; border-radius: 12px; }
        #lightbox-nav { position: absolute; top: 50%; width: 100%; display: flex; justify-content: space-between; pointer-events: none; }
        #prevBtn, #nextBtn { pointer-events: all; background: rgba(255,255,255,0.2); color: white; border: none; font-size: 40px; padding: 20px; cursor: pointer; border-radius: 50%; }
        #closeLightbox { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; font-size: 30px; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; }

        #configForm, #form {
            max-width: 800px;
            margin: 20px auto;
            background-color: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        #cancelBtn {
            position: absolute;
            top: 16px;
            left: 16px;
            background: none;
            border: none;
            font-size: 28px;
            color: #888;
            cursor: pointer;
        }
        input, button, .date-group {
            width: 100%;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 17px;
            border-radius: 12px;
            border: 1px solid #ddd;
            box-sizing: border-box;
        }
        .date-group { display: flex; gap: 10px; padding: 0; border: none; }
        .date-group input { flex: 1; margin-bottom: 0; }
        .date-group button { width: auto; padding: 12px 20px; background: #f0f0f0; color: #007aff; }
        button { background-color: #007aff; color: white; border: none; cursor: pointer; }
        #photos { padding: 20px; border: 2px dashed #ccc; text-align: center; background: #fafafa; cursor: pointer; }
        .status { text-align: center; margin: 10px 0; font-size: 14px; }
        .error { color: #ff3b30; }
        .success { color: #34c759; }
    </style>
</head>
<body>
    <h1>Our Memories</h1>

    <div id="header-controls">
        <div id="top-buttons">
            <button id="addEntry">+ New Entry</button>
            <button id="calendarBtn">ðŸ“…</button>
        </div>
        <button id="toggleView">Compact View</button>
    </div>

    <input type="text" id="searchBar" placeholder="Search by title, date, month, or year...">

    <div id="configForm">
        <h2>GitHub Setup (one-time)</h2>
        <input id="owner" placeholder="GitHub username">
        <input id="repo" placeholder="Repository name">
        <input id="token" placeholder="Personal Access Token (repo scope)" type="password">
        <button id="saveConfig">Save Config & Load Journal</button>
        <div class="status" id="configStatus"></div>
    </div>

    <div id="entries" style="display:none;"></div>

    <div id="form" style="display:none;">
        <button id="cancelBtn">Ã—</button>
        <input id="title" placeholder="Entry title (optional)">

        <div class="date-group">
            <input type="date" id="eventDate">
            <button type="button" id="todayBtn">Today</button>
        </div>

        <div id="photos">
            <p>Tap to add photos</p>
            <input type="file" id="photoInput" multiple accept="image/*" style="display:none;">
        </div>

        <div class="status" id="status"></div>
        <button id="save" disabled>Save Entry</button>
    </div>

    <!-- Calendar Modal -->
    <div id="calendarModal">
        <div id="calendarContainer">
            <div id="calendarHeader">
                <button id="prevMonth">â€¹</button>
                <span id="monthYear"></span>
                <button id="nextMonth">â€º</button>
            </div>
            <div id="calendarGrid">
                <div class="day-name">S</div><div class="day-name">M</div><div class="day-name">T</div>
                <div class="day-name">W</div><div class="day-name">T</div><div class="day-name">F</div><div class="day-name">S</div>
            </div>
        </div>
    </div>

    <!-- Lightbox -->
    <div id="lightbox">
        <button id="closeLightbox">Ã—</button>
        <img id="lightboxImg" src="">
        <div id="lightbox-nav">
            <button id="prevBtn">â€¹</button>
            <button id="nextBtn">â€º</button>
        </div>
    </div>

    <script>
        const PROXY = 'https://corsproxy.io/?';
        let owner, repo, token, entries = [];
        const dataPath = 'journal.json';
        const photosFolder = 'photos/';
        let currentPhotos = [], currentIndex = 0;
        let currentCalendarDate = new Date();

        function rawBase(path) {
            return `https://raw.githubusercontent.com/${owner}/${repo}/main/${path}`;
        }

        function loadConfig() {
            const cfg = localStorage.getItem('journalConfig');
            if (cfg) {
                ({owner, repo, token} = JSON.parse(cfg));
                document.getElementById('configForm').style.display = 'none';
                document.getElementById('entries').style.display = 'block';
                document.getElementById('header-controls').style.display = 'flex';
                document.getElementById('searchBar').style.display = 'block';
                fetchEntries();
            }
        }

        // GitHub functions (same as before)
        async function githubApi(method, path, body = null) {
            const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
            const headers = { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' };
            if (body) headers['Content-Type'] = 'application/json';
            const response = await fetch(PROXY + encodeURIComponent(url), { method, headers, body: body ? JSON.stringify(body) : null });
            if (!response.ok) throw new Error(`GitHub error ${response.status}`);
            return response.status === 204 ? null : response.json();
        }

        async function fetchEntries() {
            try {
                const file = await githubApi('GET', dataPath);
                entries = JSON.parse(atob(file.content));
                entries = entries.map(e => ({ ...e, eventDate: e.eventDate || e.date || new Date().toISOString() }));
                displayEntries();
                renderCalendar();
            } catch (e) {
                if (e.message.includes('404')) entries = [];
                displayEntries();
                renderCalendar();
            }
        }

        async function saveEntries() {
            let sha = null;
            try { const file = await githubApi('GET', dataPath); sha = file.sha; } catch {}
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(entries))));
            await githubApi('PUT', dataPath, { message: 'Update journal', content, sha });
        }

        async function uploadPhoto(file) {
            const timestamp = Date.now();
            const filename = `${timestamp}-${file.name.replace(/\s/g, '_')}`;
            const path = photosFolder + filename;
            const reader = new FileReader();
            const base64 = await new Promise(res => { reader.onload = () => res(reader.result.split(',')[1]); reader.readAsDataURL(file); });
            await githubApi('PUT', path, { message: `Add photo ${filename}`, content: base64 });
            return path;
        }

        function formatEventDate(iso) { return new Date(iso).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); }
        function formatMonthYear(date) { return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' }); }

        function getEntryDates() {
            const dates = new Set();
            entries.forEach(e => {
                const d = new Date(e.eventDate);
                dates.add(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`);
            });
            return dates;
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthYear = document.getElementById('monthYear');
            const firstDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
            const lastDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            monthYear.textContent = formatMonthYear(currentCalendarDate);

            // Clear previous days
            Array.from(grid.children).slice(7).forEach(el => el.remove());

            const entryDates = getEntryDates();
            const todayStr = new Date().toISOString().split('T')[0];

            for (let d = new Date(startDate); d <= lastDay; d.setDate(d.getDate() + 1)) {
                const dayEl = document.createElement('div');
                dayEl.className = 'day';
                dayEl.textContent = d.getDate();

                const dateStr = d.toISOString().split('T')[0];
                if (entryDates.has(dateStr)) dayEl.classList.add('has-entry');
                if (dateStr === todayStr) dayEl.classList.add('today');
                if (d.getMonth() !== currentCalendarDate.getMonth()) dayEl.classList.add('other-month');

                dayEl.onclick = () => {
                    if (entryDates.has(dateStr)) {
                        const targetEntry = document.querySelector(`[data-date="${dateStr}"]`);
                        if (targetEntry) {
                            targetEntry.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            targetEntry.style.backgroundColor = '#e6f0ff';
                            setTimeout(() => targetEntry.style.backgroundColor = '', 1000);
                        }
                    }
                    document.getElementById('calendarModal').style.display = 'none';
                };

                grid.appendChild(dayEl);
            }
        }

        function filterAndGroupEntries(term = '') {
            const lower = term.toLowerCase();
            const filtered = entries.filter(e => {
                if (!term) return true;
                const title = (e.title || '').toLowerCase();
                const dateStr = formatEventDate(e.eventDate).toLowerCase();
                const monthYear = formatMonthYear(new Date(e.eventDate)).toLowerCase();
                return title.includes(lower) || dateStr.includes(lower) || monthYear.includes(lower);
            });

            filtered.sort((a, b) => new Date(b.eventDate) - new Date(a.eventDate));

            const groups = {};
            filtered.forEach(e => {
                const key = formatMonthYear(new Date(e.eventDate));
                if (!groups[key]) groups[key] = [];
                groups[key].push(e);
            });
            return groups;
        }

        function displayEntries() {
            const container = document.getElementById('entries');
            container.innerHTML = '';
            const term = document.getElementById('searchBar').value.trim();
            const groups = filterAndGroupEntries(term);

            if (Object.keys(groups).length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#888; font-size:18px;">No entries found</p>';
                return;
            }

            Object.keys(groups).sort((a,b) => new Date(b) - new Date(a)).forEach(month => {
                const header = document.createElement('div');
                header.className = 'month-header';
                header.textContent = month;
                container.appendChild(header);

                groups[month].forEach(entry => {
                    const div = document.createElement('div');
                    div.className = 'entry';
                    div.setAttribute('data-date', entry.eventDate.split('T')[0]);

                    const firstPhoto = entry.photos.length > 0 ? rawBase(entry.photos[0]) : '';
                    const thumb = firstPhoto ? `<img class="entry-thumb" src="${firstPhoto}" alt="thumb">` : '';

                    div.innerHTML = `
                        ${thumb}
                        <div class="entry-content">
                            <div class="entry-date">${formatEventDate(entry.eventDate)}</div>
                            <div class="entry-title" contenteditable="true">${entry.title || 'Untitled'}</div>
                            <div class="entry-gallery"></div>
                        </div>
                    `;

                    div.querySelector('.entry-title').addEventListener('blur', async () => {
                        const idx = entries.findIndex(e => e.eventDate === entry.eventDate && e.date === entry.date);
                        if (idx !== -1) entries[idx].title = div.querySelector('.entry-title').textContent.trim();
                        await saveEntries();
                    });

                    const gallery = div.querySelector('.entry-gallery');
                    entry.photos.forEach((p, i) => {
                        const img = document.createElement('img');
                        img.src = rawBase(p);
                        img.onclick = () => openLightbox(entry.photos, i);
                        gallery.appendChild(img);
                    });

                    container.appendChild(div);
                });
            });
        }

        // Calendar controls
        document.getElementById('calendarBtn').onclick = () => {
            currentCalendarDate = new Date();
            renderCalendar();
            document.getElementById('calendarModal').style.display = 'flex';
        };

        document.getElementById('prevMonth').onclick = () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar();
        };

        document.getElementById('nextMonth').onclick = () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar();
        };

        document.getElementById('calendarModal').onclick = (e) => {
            if (e.target === document.getElementById('calendarModal')) {
                document.getElementById('calendarModal').style.display = 'none';
            }
        };

        // Search
        document.getElementById('searchBar').addEventListener('input', displayEntries);

        // Toggle view
        document.getElementById('toggleView').addEventListener('click', () => {
            const entriesDiv = document.getElementById('entries');
            const btn = document.getElementById('toggleView');
            if (entriesDiv.classList.contains('compact')) {
                entriesDiv.classList.remove('compact');
                btn.textContent = 'Compact View';
            } else {
                entriesDiv.classList.add('compact');
                btn.textContent = 'Gallery View';
            }
        });

        // Form and lightbox (same as previous version)
        document.getElementById('addEntry').addEventListener('click', () => {
            document.getElementById('form').style.display = 'block';
            document.getElementById('header-controls').style.display = 'none';
            document.getElementById('searchBar').style.display = 'none';
            document.getElementById('eventDate').value = new Date().toISOString().split('T')[0];
        });

        document.getElementById('cancelBtn').addEventListener('click', () => {
            document.getElementById('form').style.display = 'none';
            document.getElementById('header-controls').style.display = 'flex';
            document.getElementById('searchBar').style.display = 'block';
        });

        // ... [rest of form, photo upload, lightbox code remains identical to previous version]

        document.getElementById('todayBtn').onclick = () => document.getElementById('eventDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('photos').onclick = () => document.getElementById('photoInput').click();

        const photoInput = document.getElementById('photoInput');
        const status = document.getElementById('status');
        const saveBtn = document.getElementById('save');
        let selectedFiles = [];

        photoInput.addEventListener('change', () => {
            selectedFiles = Array.from(photoInput.files);
            status.textContent = selectedFiles.length ? `${selectedFiles.length} photo${selectedFiles.length > 1 ? 's' : ''} selected` : '';
            status.className = 'status success';
            saveBtn.disabled = !selectedFiles.length;
        });

        saveBtn.addEventListener('click', async () => {
            if (!selectedFiles.length) return alert('Add at least one photo');
            const eventDate = document.getElementById('eventDate').value;
            if (!eventDate) return alert('Please select an event date');

            status.textContent = 'Uploading...';
            try {
                const paths = [];
                for (const file of selectedFiles) {
                    status.textContent = `Uploading ${file.name}...`;
                    paths.push(await uploadPhoto(file));
                }

                entries.push({
                    date: new Date().toISOString(),
                    eventDate: new Date(eventDate).toISOString(),
                    title: document.getElementById('title').value.trim() || 'Untitled',
                    photos: paths
                });

                await saveEntries();
                displayEntries();
                renderCalendar();

                document.getElementById('form').style.display = 'none';
                document.getElementById('header-controls').style.display = 'flex';
                document.getElementById('searchBar').style.display = 'block';
                document.getElementById('title').value = '';
                photoInput.value = '';
                selectedFiles = [];
                saveBtn.disabled = true;
                status.textContent = 'Saved!';
                status.className = 'status success';
            } catch (e) {
                status.textContent = 'Error: ' + e.message;
                status.className = 'status error';
            }
        });

        // Lightbox (unchanged)
        function openLightbox(photos, idx) {
            currentPhotos = photos; currentIndex = idx;
            document.getElementById('lightboxImg').src = rawBase(photos[idx]);
            document.getElementById('lightbox').style.display = 'flex';
        }
        document.getElementById('closeLightbox').onclick = () => document.getElementById('lightbox').style.display = 'none';
        document.getElementById('prevBtn').onclick = () => { currentIndex = (currentIndex - 1 + currentPhotos.length) % currentPhotos.length; document.getElementById('lightboxImg').src = rawBase(currentPhotos[currentIndex]); };
        document.getElementById('nextBtn').onclick = () => { currentIndex = (currentIndex + 1) % currentPhotos.length; document.getElementById('lightboxImg').src = rawBase(currentPhotos[currentIndex]); };
        document.getElementById('lightbox').onclick = (e) => { if (e.target === document.getElementById('lightbox')) document.getElementById('lightbox').style.display = 'none'; };

        loadConfig();
    </script>
</body>
</html>
