<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Journal App</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f8f8f8;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        #entries {
            max-width: 800px;
            margin: 0 auto;
        }
        .entry {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .entry-date {
            font-size: 14px;
            color: #888;
            margin-bottom: 10px;
        }
        .entry-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            cursor: text;
        }
        .entry-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }
        .entry-gallery img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            object-fit: cover;
        }
        #addEntry {
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 16px;
            cursor: pointer;
            display: block;
            margin: 20px auto;
        }
        #form {
            max-width: 800px;
            margin: 20px auto;
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        #title {
            width: 100%;
            padding: 10px;
            font-size: 18px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #photos {
            margin-bottom: 10px;
        }
        #save {
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            cursor: pointer;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="entries"></div>
    <button id="addEntry">Add New Entry</button>
    <div id="form" class="hidden">
        <input id="title" placeholder="Enter title (optional)">
        <input type="file" id="photos" multiple accept="image/*">
        <button id="save">Save Entry</button>
    </div>

    <script>
        // Replace these with your actual GitHub details
        const owner = 'YOUR_GITHUB_USERNAME'; // e.g., 'octocat'
        const repo = 'YOUR_REPO_NAME'; // e.g., 'journal-app'
        const token = 'YOUR_PERSONAL_ACCESS_TOKEN'; // Generate a PAT with repo scope at https://github.com/settings/tokens
        const dataPath = 'journal.json';
        const photosFolder = 'photos/';
        const rawBaseUrl = `https://raw.githubusercontent.com/${owner}/${repo}/main/`;

        let entries = [];

        // Helper to make GitHub API requests
        async function githubApi(method, path, body = null) {
            const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
            const headers = {
                Authorization: `token ${token}`,
                Accept: 'application/vnd.github.v3+json'
            };
            const response = await fetch(url, {
                method,
                headers,
                body: body ? JSON.stringify(body) : null
            });
            if (!response.ok) {
                throw new Error(`GitHub API error: ${response.statusText}`);
            }
            return response.json();
        }

        // Fetch the journal.json if exists
        async function fetchEntries() {
            try {
                const file = await githubApi('GET', dataPath);
                entries = JSON.parse(atob(file.content));
                displayEntries();
            } catch (error) {
                if (error.message.includes('Not Found')) {
                    entries = [];
                    displayEntries();
                } else {
                    console.error('Error fetching entries:', error);
                }
            }
        }

        // Upload or update journal.json
        async function saveEntries() {
            let sha = null;
            try {
                const file = await githubApi('GET', dataPath);
                sha = file.sha;
            } catch (error) {
                // File doesn't exist yet, no sha
            }
            const content = btoa(JSON.stringify(entries));
            await githubApi('PUT', dataPath, {
                message: 'Update journal entries',
                content,
                sha
            });
        }

        // Upload a photo and return its path
        async function uploadPhoto(file) {
            const timestamp = new Date().getTime();
            const filename = `${timestamp}-${file.name.replace(/\s/g, '_')}`;
            const path = `${photosFolder}${filename}`;
            const reader = new FileReader();
            return new Promise((resolve, reject) => {
                reader.onload = async () => {
                    const content = reader.result.split(',')[1]; // Base64 without prefix
                    try {
                        await githubApi('PUT', path, {
                            message: `Add photo ${filename}`,
                            content
                        });
                        resolve(path);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        // Display entries, sorted newest first
        function displayEntries() {
            const container = document.getElementById('entries');
            container.innerHTML = '';
            entries.sort((a, b) => new Date(b.date) - new Date(a.date));
            entries.forEach((entry, index) => {
                const div = document.createElement('div');
                div.className = 'entry';
                div.innerHTML = `
                    <div class="entry-date">${new Date(entry.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                    <span class="entry-title" contenteditable="true">${entry.title || 'Untitled'}</span>
                    <div class="entry-gallery"></div>
                `;
                const titleSpan = div.querySelector('.entry-title');
                titleSpan.addEventListener('blur', async () => {
                    entries[index].title = titleSpan.textContent.trim();
                    await saveEntries();
                });
                const gallery = div.querySelector('.entry-gallery');
                entry.photos.forEach(photoPath => {
                    const img = document.createElement('img');
                    img.src = `${rawBaseUrl}${photoPath}`;
                    gallery.appendChild(img);
                });
                container.appendChild(div);
            });
        }

        // Event listeners
        document.getElementById('addEntry').addEventListener('click', () => {
            document.getElementById('form').classList.toggle('hidden');
        });

        document.getElementById('save').addEventListener('click', async () => {
            const title = document.getElementById('title').value.trim();
            const files = document.getElementById('photos').files;
            if (files.length === 0) {
                alert('Please add at least one photo.');
                return;
            }
            const photoPaths = [];
            for (const file of files) {
                try {
                    const path = await uploadPhoto(file);
                    photoPaths.push(path);
                } catch (error) {
                    console.error('Error uploading photo:', error);
                    alert('Failed to upload a photo.');
                    return;
                }
            }
            entries.push({
                date: new Date().toISOString(),
                title: title || 'Untitled',
                photos: photoPaths
            });
            await saveEntries();
            displayEntries();
            document.getElementById('form').classList.add('hidden');
            document.getElementById('title').value = '';
            document.getElementById('photos').value = '';
        });

        // Initial load
        fetchEntries();
    </script>
</body>
</html>
